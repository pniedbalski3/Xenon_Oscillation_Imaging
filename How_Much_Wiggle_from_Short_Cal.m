clear;clc;close all;

%%
folders = {'P:\IRB_STUDY00146119_Xe_Imaging\20221028_Xe-047',...
'P:\IRB_STUDY00146119_Xe_Imaging\20221115_Xe-049',...
'P:\IRB_STUDY00146119_Xe_Imaging\20221222_Xe-050',...
'P:\IRB_STUDY00146119_Xe_Imaging\20210902_Xe-021',...
'P:\IRB_STUDY00146119_Xe_Imaging\20210917_Xe-022',...
'P:\IRB_STUDY00146119_Xe_Imaging\20210929_Xe-023',...
'P:\IRB_STUDY00146119_Xe_Imaging\20211004_Xe-024',...
'P:\IRB_STUDY00146119_Xe_Imaging\20211011_Xe-025',...
'P:\IRB_STUDY00146119_Xe_Imaging\20211028_Xe-026',...
'P:\IRB_STUDY00146119_Xe_Imaging\20211105_Xe-027',...
'P:\IRB_STUDY00146119_Xe_Imaging\20211116_Xe-028',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220315_Xe-031',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220321_Xe-029',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220405_Xe-032',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220421_Xe-034',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220512_Xe-036',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220518_Xe-033',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220520_Xe-035',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220606_Xe-037',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220617_Xe-030',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220620_Xe-039',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220629_Xe-040',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220629_Xe-042',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220629_Xe-043',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220630_Xe-044',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220701_Xe-038',...
'P:\IRB_STUDY00146119_Xe_Imaging\20220712_Xe-041',...
'P:\IRB_STUDY00146119_Xe_Imaging\20221018_Xe-045',...
'P:\IRB_STUDY00146119_Xe_Imaging\20221025_Xe-046',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20221031_CXe-020_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20221109_CXe-041',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20221201_CXe-038_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20221213_CXe-036_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20210921_CXe-006',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20210924_CXe-007',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211021_CXe-008',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211021_CXe-009',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211102_CXe-010',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211105_CXe-011',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211117_CXe-001_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211122_CXe-012',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211213_CXe-002_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20211214_CXe-003_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220110_CXe-005_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220111_CXe-004_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220216_CXe-013',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220225_CXe-007_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220304_CXe-015',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220308_CXe-016',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220309_CXe-014',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220310_CXe-006_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220323_CXe-018',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220325_CXe-019',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220330_CXe-017',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220414_CXe-008_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220414_CXe-021',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220414_CXe-023',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220418_CXe-022',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220418_CXe-025',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220419_CXe-027',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220426_CXe-026',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220427_CXe-028',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220429_CXe-010_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220503_CXe-012_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220503_CXe-029',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220510_CXe-011_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220512_CXe-020',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220513_CXe-030',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220523_CXe-031',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220523_CXe-035',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220524_CXe-034',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220526_CXe-032',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220526_CXe-033',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220601_CXe-040',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220602_CXe-037',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220607_CXe-038',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220607_CXe-039',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220609_CXe-036',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220627_CXe-024',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220810_CXe-015_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220902_CXe-016_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220907_CXe-017_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20220919_CXe-022_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20221013_CXe-013_02',...
'P:\IRB_STUDY00146616_COVID_Xe_MRI\20221026_CXe-034_02',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220616_201-09',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220714_201-03_V2',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220830_201-04_V2',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220909_201-05_V2',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220915_201-07_V2',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220922_201-08_V2',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20221011_201-10',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20221118_201-11',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20221121_201-12',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20230112_201-13',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20230118_201-14',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20230203_201-15',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20230210_201-11_V2',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20230213_201-12_V2',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20230215_201-16',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220315_201-01',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220421_201-03',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220422_201-02',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220511_201-04',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220519_201-05',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220525_201-06',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220601_201-07',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220609_201-08',...
'P:\IRB_STUDY00146919_Comparison_Exercise\Imaging_Data\20220614_201-01_V2',...
};

%folders = {'P:\IRB_STUDY00146119_Xe_Imaging\20220520_Xe-035'};
search_name = 'Duke_Xe_Calibration';

Gas = zeros(140,length(folders));
RBC = zeros(140,length(folders));
Mem = zeros(140,length(folders));
RBC_Shift = zeros(140,length(folders));
Mem_Shift = zeros(140,length(folders));
figure('Name','RBC Wiggles')

Amp = zeros(length(folders),1);
Phase = zeros(length(folders),1);
Rate = zeros(length(folders),1);
Part{length(folders),1} = ' ';

%%

headers = {'Subject','RBC_Osc','RBCMem_Osc'};
AllWiggles = cell2table(cell(0,size(headers,2)));
AllWiggles.Properties.VariableNames = headers;

for i = 1:length(folders)
    tmp_fold = folders{i};
    if strcmp(tmp_fold((end-1):end),'02')
        Part{i} = tmp_fold((end-9):end);
    else
        Part{i} = tmp_fold((end-6):end);
        if strcmp(Part{i}(1),'_')
            Part{i} = tmp_fold((end-5):end);
        end
    end
    files = struct2cell(dir(fullfile(tmp_fold,'Raw')));
    names = files(1,:);
    
    try
        myfile = names{find(contains(names,search_name),1,'last')};

        twix = mapVBVD(fullfile(tmp_fold,'Raw',myfile));
        dwell_time = twix.hdr.MeasYaps.sRXSPEC.alDwellTime{1,1};
        dwell_time=dwell_time*1E-9; 
        nFids = twix.hdr.Config.NRepMeas;
        nPts = twix.hdr.Config.VectorSize;
        nDis = twix.hdr.Phoenix.sWipMemBlock.alFree{2};

        theFID = squeeze(double(twix.image()));
        te = twix.hdr.Phoenix.alTE{1}; 

        disData = theFID(:,1:nDis);

        %Kill the first 60 points (gets us 2s of data... not great, but maybe enough?)
        disData(:,1:60) = [];
        t = double((0:(length(disData)-1))*dwell_time');

        for j = 1:size(disData,2)
            disfitObj = NMR_TimeFit_v(disData(:,j),t,[1 1 1],[0 -700  -7400],[250 200 30],[0 200 0],[0 0 0],2,length(t)*2); % first widths lorenzian, 2nd are gauss
            disfitObj = disfitObj.fitTimeDomainSignal();
            %disfitObj.plotTimeAndSpectralFit;
            Gas(j,i) = disfitObj.area(3);
            RBC(j,i) = disfitObj.area(1);
            Mem(j,i) = disfitObj.area(2);
            Mem_Shift(j,i) = disfitObj.freq(2);
            RBC_Shift(j,i) = disfitObj.freq(1);
        end
        
        save(fullfile(tmp_fold,'Spectra_fittings.mat'),'Gas','RBC','Mem','Mem_Shift','RBC_Shift');
        xdata = 0:0.015:(0.015*(size(RBC,1)-1));
        myfit = fit(xdata',RBC(:,i),'exp2');

        det_RBC = RBC(:,i)./myfit(xdata);
        det_RBC = det_RBC-1;

        sinfit = fit(xdata',smooth(det_RBC),'sin1');

        Amp(i) = 2*sinfit.a1*100;
        Phase(i) = sinfit.c1;
        Rate = sinfit.b1/2/pi*60;
        myfig = figure('Name','Spectra Fitting');
        %plot(abs(disData(1,:)));
        subplot(1,2,1)
        plot(xdata,smooth(det_RBC),xdata,sinfit(xdata));
        title(['Osc Amp = ',num2str(Amp(i),3)]);
        
        R2M = RBC(:,i)./Mem(:,i);
        
        R2M = R2M - mean(R2M);
        
        sinfit2 = fit(xdata',smooth(R2M),'sin1');
        
        subplot(1,2,1)
        plot(xdata,smooth(det_RBC),xdata,sinfit(xdata));
        title(['Osc Amp = ',num2str(Amp(i),3)]);
        
        
        R2MAmp(i) = 2*sinfit2.a1;
        subplot(1,2,2)
        plot(xdata,smooth(R2M),xdata,sinfit2(xdata));
        title(['R2M Osc Amp = ',num2str(R2MAmp(i),3)]);
        
        saveas(myfig,fullfile(tmp_fold,'Wiggle_Spectra_Figs.png'))
        
        newline = {Part{i},Amp(i),R2MAmp(i)};
        AllWiggles = [AllWiggles;newline];
    catch
        Amp(i) = nan;
        Phase(i) = nan;
        Rate(i) = nan;
    end
end

%%
% figure;
% for i = 1:length(folders)
%     subplot(1,3,i);plot(smooth(RBC(:,i)));
% end
% 


